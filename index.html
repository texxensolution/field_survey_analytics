<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Response Analytics Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.3.0/chart.umd.min.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    
    <style>
        :root {
            --primary: #63f16d;
            --primary-dark: #20653c;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --dark: #1f2937;
            --light: #f8fafc;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.3);
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            --blur: blur(16px);
        }
        
        * {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            font-feature-settings: "kern" 1;
            text-rendering: optimizeLegibility;
        }
        
        .glass {
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
            border-radius: 20px;
        }
        
        .navbar {
            backdrop-filter: var(--blur);
            border-bottom: 1px solid var(--glass-border);
        }
        
        .navbar-brand {
            font-weight: 800;
            font-size: 1.5rem;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .metric-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 20px;
            border: none;
            box-shadow: var(--shadow-lg);
            transform-origin: center;
        }
        
        .metric-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
        }
        
        .metric-card.success { 
            background: linear-gradient(135deg, var(--success), #059669); 
        }
        .metric-card.info { 
            background: linear-gradient(135deg, var(--info), #0891b2); 
        }
        .metric-card.warning { 
            background: linear-gradient(135deg, var(--warning), #d97706); 
        }
        .metric-card.danger { 
            background: linear-gradient(135deg, var(--danger), #dc2626); 
        }
        
        .btn-modern {
            background: var(--primary);
            border: none;
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        
        .btn-modern:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            color: white;
        }
        
        .upload-zone {
            border: 3px dashed #cbd5e1;
            border-radius: 20px;
            background: rgba(248, 250, 252, 0.8);
            backdrop-filter: var(--blur);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
            transform: scale(1.01);
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.15);
        }
        
        .table-modern {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .table-modern th {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            font-weight: 600;
            border: none;
            padding: 16px;
        }
        
        .table-modern tbody tr {
            border: none;
        }
        
        .table-modern tbody tr:hover {
            background: rgba(99, 102, 241, 0.05);
            transform: translateX(4px);
        }
        
        .status-badge {
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .highlight-cannot-comply {
            background: linear-gradient(90deg, #fef2f2, #fee2e2) !important;
            border-left: 4px solid var(--danger) !important;
        }
        
        .highlight-issue-reported {
            background: linear-gradient(90deg, #fffbeb, #fef3c7) !important;
            border-left: 4px solid var(--warning) !important;
        }
        
        .insight-card {
            border-left: 4px solid;
            border-radius: 0 16px 16px 0;
            backdrop-filter: var(--blur);
        }
        
        .insight-card:hover {
            transform: translateX(8px);
        }
        
        .insight-card.primary { border-left-color: var(--primary); }
        .insight-card.success { border-left-color: var(--success); }
        .insight-card.warning { border-left-color: var(--warning); }
        .insight-card.danger { border-left-color: var(--danger); }
        
        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 0.3rem solid rgba(99, 102, 241, 0.2);
            border-top: 0.3rem solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .nav-pills .nav-link {
            border-radius: 12px;
            font-weight: 600;
            margin: 0 4px;
        }
        
        .nav-pills .nav-link.active {
            background: var(--primary);
            color: white;
        }
        
        .pagination .page-link {
            border-radius: 8px;
            margin: 0 2px;
            font-weight: 600;
            border: none;
            color: var(--primary);
        }
        
        .pagination .page-item.active .page-link {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            padding: 20px;
        }
        
        .cursor-pointer {
            cursor: pointer;
        }
        
        .text-truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .badge-modern {
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
        }
        
        .alert-modern {
            border-radius: 12px;
            border: none;
            backdrop-filter: var(--blur);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark glass mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                üìä Task Response Analytics
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text text-dark>
                    üìÖ <span id="current-date"></span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <!-- Alerts -->
        <div id="alerts-container"></div>

        <!-- Welcome Header -->
        <div class="text-center mb-5">
            <div class="glass p-5 fade-in">
                <h1 class="display-4 fw-bold mb-3">üìä Task Response Analytics</h1>
                <p class="lead text-muted">Comprehensive analysis and insights for task response data with real-time visualization</p>
            </div>
        </div>

        <!-- Data Source Section -->
        <div id="data-source-section" class="glass p-4 mb-4">
            <ul class="nav nav-pills mb-4" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="upload-tab" data-tab="upload">üì§ Upload File</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="endpoint-tab" data-tab="endpoint">üåê Fetch from API</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sample-tab" data-tab="sample">üß™ Try Sample Data</button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Upload Tab -->
                <div id="upload-content" class="tab-pane show active">
                    <div class="upload-zone p-5 text-center" id="upload-zone">
                        <div id="upload-default">
                            <div style="font-size: 4rem;">üì§</div>
                            <h4 class="mb-3">Drag & Drop JSON File</h4>
                            <p class="text-muted mb-4">Or click here to browse files</p>
                            <div class="mb-4">
                                <button type="button" class="btn btn-modern btn-lg" onclick="document.getElementById('file-input').click()">
                                    üìÅ Choose File
                                </button>
                            </div>
                            <div class="row">
                                <div class="col-md-8 mx-auto">
                                    <div class="alert alert-info alert-modern">
                                        <strong>üí° Supported Format:</strong>
                                        <ul class="mb-0 mt-2 text-start">
                                            <li>JSON files with arrays or objects containing message data</li>
                                            <li>Required fields: user_name, message_type, status, sent_at</li>
                                            <li>Supports nested structures with "messages" or "data" properties</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="upload-loading" class="d-none">
                            <div class="loading-spinner mx-auto mb-3"></div>
                            <h5 class="text-primary">Processing your data...</h5>
                        </div>
                    </div>
                    <input type="file" id="file-input" accept=".json" class="d-none">
                </div>

                <!-- Endpoint Tab -->
                <div id="endpoint-content" class="tab-pane">
                    <div class="row justify-content-center">
                        <div class="col-lg-8">
                            <h4 class="text-center mb-4">üåê Fetch Data from API Endpoint</h4>
                            <div class="mb-4">
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text">üîó</span>
                                    <input type="url" class="form-control" id="endpoint-input" 
                                           placeholder="https://api.example.com/task-responses">
                                    <button class="btn btn-modern" id="fetch-btn">‚¨áÔ∏è Fetch Data</button>
                                </div>
                            </div>
                            <div class="alert alert-warning alert-modern">
                                <strong>‚ö†Ô∏è CORS Notice:</strong> Make sure your API endpoint supports CORS or use a proxy service. 
                                Some endpoints may require authentication headers.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sample Data Tab -->
                <div id="sample-content" class="tab-pane">
                    <div class="text-center">
                        <div style="font-size: 4rem;">üß™</div>
                        <h4 class="mb-3">Try Sample Data</h4>
                        <p class="text-muted mb-4">Load 50 sample records to explore the dashboard features</p>
                        <button class="btn btn-modern btn-lg" id="sample-btn">üöÄ Load Sample Data</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard-content" class="d-none">
            <!-- Filters Section -->
            <div class="glass p-4 mb-4">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">üè∑Ô∏è Message Type</label>
                        <select class="form-select" id="filter-type">
                            <option value="all">All Types</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">‚úÖ Status</label>
                        <select class="form-select" id="filter-status">
                            <option value="all">All Statuses</option>
                            <option value="acknowledged">Acknowledged</option>
                            <option value="sent">Sent</option>
                            <option value="cannot_comply">Cannot Comply</option>
                            <option value="issue_reported">Issue Reported</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">üîç Search User</label>
                        <input type="text" class="form-control" id="filter-user" placeholder="Enter user name...">
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid">
                            <button class="btn btn-outline-primary" id="new-data-btn">üìÇ Load New Data</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Metrics Cards -->
            <div class="row g-4 mb-4" id="metrics-cards">
                <!-- Cards will be populated by JavaScript -->
            </div>

            <!-- Charts Section -->
            <div class="row g-4 mb-4">
                <div class="col-lg-6">
                    <div class="glass h-100">
                        <div class="card-header bg-transparent border-0 pt-4">
                            <h5 class="card-title mb-0">ü•ß Status Distribution</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="status-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="glass h-100">
                        <div class="card-header bg-transparent border-0 pt-4">
                            <h5 class="card-title mb-0">üìä Response Rates by Type</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="response-chart"></canvas>
                            </div>
                            <div id="response-stats" class="row g-2 mt-2">
                                <!-- Stats will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Insights Section -->
            <div class="glass mb-4">
                <div class="card-header bg-transparent border-0 pt-4">
                    <button class="btn btn-link text-decoration-none p-0 w-100 text-start" id="insights-toggle">
                        <h5 class="card-title mb-0">üí° Key Insights & Analytics <span class="float-end">üîΩ</span></h5>
                    </button>
                </div>
                <div class="card-body" id="insights-body">
                    <div class="row g-3" id="insights-grid">
                        <!-- Insights will be populated by JavaScript -->
                    </div>
                    <div class="row g-2 mt-3">
                        <div class="col-auto">
                            <button class="btn btn-outline-danger" id="highlight-btn">üëÅÔ∏è Highlight Issues</button>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-success" id="export-btn">üì• Export Data</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="glass">
                <div class="card-header bg-transparent border-0 pt-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0" id="table-title">üìã Message Details</h5>
                        <div class="badge bg-primary fs-6" id="page-badge">Page 1 of 1</div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-modern mb-0">
                            <thead>
                                <tr>
                                    <th class="cursor-pointer" data-sort="user_name">User Name <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                    <th class="cursor-pointer" data-sort="message_type">Message Type <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                    <th class="cursor-pointer" data-sort="status">Status <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                    <th class="cursor-pointer" data-sort="sent_at">Sent Time <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                    <th>Acknowledged Time</th>
                                    <th>Message Content</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer bg-transparent border-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-muted" id="pagination-info">Showing 0 to 0 of 0 results</div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0" id="pagination">
                                    <!-- Pagination will be populated by JavaScript -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="text-center mt-4 p-3 glass">
                <p class="text-muted mb-0">
                    ‚öôÔ∏è Last updated: <span id="last-updated"></span>
                </p>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let state = {
            data: [],
            filteredData: [],
            filters: {
                messageType: 'all',
                status: 'all',
                searchUser: ''
            },
            currentPage: 1,
            itemsPerPage: 12,
            sortConfig: { key: null, direction: 'asc' },
            highlightIssues: false,
            showInsights: true,
            charts: {
                status: null,
                response: null
            }
        };

        // Utility functions
        const showAlert = (message, type = 'info') => {
            const alertsContainer = document.getElementById('alerts-container');
            const alertId = `alert-${Date.now()}`;
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show alert-modern" role="alert">
                    ${type === 'danger' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'} ${message}
                    <button type="button" class="btn-close" onclick="document.getElementById('${alertId}').remove()"></button>
                </div>
            `;
            alertsContainer.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) alert.remove();
            }, 5000);
        };

        const formatDateTime = (dateString) => {
            if (!dateString) return 'N/A';
            try {
                return new Date(dateString).toLocaleString();
            } catch {
                return 'Invalid Date';
            }
        };

        const getStatusBadge = (status) => {
            const badges = {
                acknowledged: '<span class="status-badge bg-success">Acknowledged</span>',
                sent: '<span class="status-badge bg-secondary">Sent</span>',
                cannot_comply: '<span class="status-badge bg-danger">Cannot Comply</span>',
                issue_reported: '<span class="status-badge bg-warning text-dark">Issue Reported</span>'
            };
            return badges[status] || '<span class="status-badge bg-secondary">Unknown</span>';
        };

        const calculateStats = (data) => {
            const stats = {
                total: data.length,
                acknowledged: data.filter(d => d.status === 'acknowledged').length,
                sent: data.filter(d => d.status === 'sent').length,
                cannotComply: data.filter(d => d.status === 'cannot_comply').length,
                issueReported: data.filter(d => d.status === 'issue_reported').length,
                messageTypes: [...new Set(data.map(d => d.message_type).filter(type => type != null))].sort(),
                missingData: data.filter(d => !d.user_name || d.user_name.trim() === '').length
            };
            return stats;
        };

        const generateSampleData = () => {
            const messageTypes = ['morning_checkin', 'evening_checkin', 'mid_day_update', 'weekly_report'];
            const statuses = ['acknowledged', 'sent', 'cannot_comply', 'issue_reported'];
            const userNames = ['John Doe', 'Jane Smith', 'Mike Johnson', 'Sarah Wilson', 'Tom Brown', 'Lisa Davis'];
            
            const sampleData = [];
            for (let i = 0; i < 50; i++) {
                const sentDate = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000);
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                
                sampleData.push({
                    id: i + 1,
                    user_name: userNames[Math.floor(Math.random() * userNames.length)],
                    message_type: messageTypes[Math.floor(Math.random() * messageTypes.length)],
                    status: status,
                    sent_at: sentDate.toISOString(),
                    acknowledged_at: status === 'acknowledged' ? new Date(sentDate.getTime() + Math.random() * 24 * 60 * 60 * 1000).toISOString() : null,
                    message_content: `Sample message content for ${messageTypes[Math.floor(Math.random() * messageTypes.length)].replace(/_/g, ' ')}`
                });
            }
            return sampleData;
        };

        // Data loading functions
        const handleFileUpload = async (file) => {
            if (!file) return;
            
            showLoadingState(true);
            
            try {
                const text = await file.text();
                const jsonData = JSON.parse(text);
                
                let dataArray;
                if (Array.isArray(jsonData)) {
                    dataArray = jsonData;
                } else if (jsonData.messages && Array.isArray(jsonData.messages)) {
                    dataArray = jsonData.messages;
                } else if (jsonData.data && Array.isArray(jsonData.data)) {
                    dataArray = jsonData.data;
                } else {
                    throw new Error('Invalid data format: Expected array or object with "messages" or "data" property');
                }
                
                if (dataArray.length === 0) {
                    throw new Error('No data found: Array is empty');
                }
                
                const requiredFields = ['user_name', 'message_type', 'status', 'sent_at'];
                const sampleRecord = dataArray[0];
                const missingFields = requiredFields.filter(field => !(field in sampleRecord));
                
                if (missingFields.length > 0) {
                    throw new Error(`Missing required fields: ${missingFields.join(', ')}`);
                }
                
                loadData(dataArray);
                showAlert(`Successfully loaded ${dataArray.length} records from file!`, 'success');
                
            } catch (err) {
                showAlert(`Failed to process file: ${err.message}`, 'danger');
            } finally {
                showLoadingState(false);
            }
        };

        const handleEndpointFetch = async () => {
            const endpoint = document.getElementById('endpoint-input').value;
            if (!endpoint.trim()) {
                showAlert('Please enter a valid endpoint URL', 'danger');
                return;
            }

            showLoadingState(true);

            try {
                const response = await fetch(endpoint, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    const responseText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${response.statusText}. Response: ${responseText.substring(0, 200)}...`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const responseText = await response.text();
                    throw new Error(`Expected JSON response but got: ${contentType}. Response: ${responseText.substring(0, 200)}...`);
                }
                
                const jsonData = await response.json();
                
                let dataArray;
                if (Array.isArray(jsonData)) {
                    dataArray = jsonData;
                } else if (jsonData.messages && Array.isArray(jsonData.messages)) {
                    dataArray = jsonData.messages;
                } else if (jsonData.data && Array.isArray(jsonData.data)) {
                    dataArray = jsonData.data;
                } else {
                    throw new Error('Invalid response format: Expected array or object with "messages" or "data" property');
                }
                
                if (dataArray.length === 0) {
                    throw new Error('No data found in response');
                }
                
                const requiredFields = ['user_name', 'message_type', 'status', 'sent_at'];
                const sampleRecord = dataArray[0];
                const missingFields = requiredFields.filter(field => !(field in sampleRecord));
                
                if (missingFields.length > 0) {
                    throw new Error(`Missing required fields in response: ${missingFields.join(', ')}`);
                }
                
                loadData(dataArray);
                showAlert(`Successfully fetched ${dataArray.length} records from endpoint!`, 'success');
                
            } catch (err) {
                if (err.name === 'TypeError' && err.message.includes('fetch')) {
                    showAlert('Network error: Unable to reach the endpoint. This could be due to CORS restrictions, network issues, or the endpoint being unavailable.', 'danger');
                } else if (err.message.includes('<!DOCTYPE') || err.message.includes('&lt;!DOCTYPE')) {
                    showAlert('Server returned HTML instead of JSON. This usually indicates an authentication error, server error, or wrong endpoint URL.', 'danger');
                } else {
                    showAlert(`Failed to fetch data: ${err.message}`, 'danger');
                }
            } finally {
                showLoadingState(false);
            }
        };

        const loadSampleData = () => {
            const sampleData = generateSampleData();
            loadData(sampleData);
            showAlert(`Loaded ${sampleData.length} sample records for demonstration!`, 'success');
        };

        const loadData = (data) => {
            state.data = data;
            state.filteredData = data;
            state.currentPage = 1;
            
            // Hide data source section and show dashboard
            document.getElementById('data-source-section').style.display = 'none';
            document.getElementById('dashboard-content').classList.remove('d-none');
            document.getElementById('dashboard-content').classList.add('fade-in');
            
            // Update filters
            updateFilters();
            
            // Render everything
            renderMetrics();
            renderCharts();
            renderInsights();
            renderTable();
            
            // Update last updated time
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
        };

        const showLoadingState = (loading) => {
            const uploadDefault = document.getElementById('upload-default');
            const uploadLoading = document.getElementById('upload-loading');
            const fetchBtn = document.getElementById('fetch-btn');
            
            if (loading) {
                uploadDefault.classList.add('d-none');
                uploadLoading.classList.remove('d-none');
                fetchBtn.disabled = true;
                fetchBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Fetching...';
            } else {
                uploadDefault.classList.remove('d-none');
                uploadLoading.classList.add('d-none');
                fetchBtn.disabled = false;
                fetchBtn.innerHTML = '‚¨áÔ∏è Fetch Data';
            }
        };

        // Rendering functions
        const updateFilters = () => {
            const stats = calculateStats(state.data);
            const typeSelect = document.getElementById('filter-type');
            
            // Clear and rebuild type filter
            typeSelect.innerHTML = '<option value="all">All Types</option>';
            stats.messageTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type ? type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Unknown Type';
                typeSelect.appendChild(option);
            });
        };

        const renderMetrics = () => {
            const stats = calculateStats(state.data);
            const container = document.getElementById('metrics-cards');
            
            // Calculate best performer
            const messageTypeStats = stats.messageTypes.map(type => ({
                type,
                total: state.data.filter(d => d.message_type === type).length,
                acknowledged: state.data.filter(d => d.message_type === type && d.status === 'acknowledged').length,
                responseRate: ((state.data.filter(d => d.message_type === type && d.status === 'acknowledged').length / 
                              state.data.filter(d => d.message_type === type).length) * 100).toFixed(1)
            }));
            
            const bestPerformer = messageTypeStats.length > 0 ? 
                messageTypeStats.reduce((best, current) => 
                    parseFloat(current.responseRate) > parseFloat(best.responseRate) ? current : best
                ) : null;
            
            container.innerHTML = `
                <div class="col-lg-3 col-md-6">
                    <div class="card metric-card text-white h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="card-title opacity-75">Total Messages</h6>
                                    <h2 class="card-text fw-bold">${stats.total.toLocaleString()}</h2>
                                    <small class="opacity-75">${stats.messageTypes.length} message types</small>
                                </div>
                                <div style="font-size: 3rem; opacity: 0.5;">üìä</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card metric-card success text-white h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="card-title opacity-75">Response Rate</h6>
                                    <h2 class="card-text fw-bold">${((stats.acknowledged / stats.total) * 100).toFixed(1)}%</h2>
                                    <small class="opacity-75">${stats.acknowledged.toLocaleString()} acknowledged</small>
                                </div>
                                <div style="font-size: 3rem; opacity: 0.5;">‚úÖ</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card metric-card info text-white h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="card-title opacity-75">Best Performer</h6>
                                    <h6 class="card-text fw-bold">${bestPerformer ? bestPerformer.type.replace(/_/g, ' ') : 'N/A'}</h6>
                                    <small class="opacity-75">${bestPerformer ? bestPerformer.responseRate + '% rate' : 'No data'}</small>
                                </div>
                                <div style="font-size: 3rem; opacity: 0.5;">üèÜ</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card metric-card warning text-white h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="card-title opacity-75">Issues Found</h6>
                                    <h2 class="card-text fw-bold">${stats.cannotComply + stats.issueReported}</h2>
                                    <small class="opacity-75">Require attention</small>
                                </div>
                                <div style="font-size: 3rem; opacity: 0.5;">‚ö†Ô∏è</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderCharts = () => {
            const stats = calculateStats(state.data);
            
            // Destroy existing charts
            if (state.charts.status) state.charts.status.destroy();
            if (state.charts.response) state.charts.response.destroy();
            
            // Status chart
            const statusCtx = document.getElementById('status-chart').getContext('2d');
            state.charts.status = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Acknowledged', 'Sent/Unacknowledged', 'Cannot Comply', 'Issue Reported'],
                    datasets: [{
                        data: [stats.acknowledged, stats.sent, stats.cannotComply, stats.issueReported],
                        backgroundColor: ['#10b981', '#6b7280', '#ef4444', '#f59e0b'],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: { size: 12, weight: 'bold' }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const percentage = ((context.parsed / stats.total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
            
            // Response rate chart
            const messageTypeStats = stats.messageTypes.map(type => ({
                type,
                total: state.data.filter(d => d.message_type === type).length,
                acknowledged: state.data.filter(d => d.message_type === type && d.status === 'acknowledged').length,
                responseRate: ((state.data.filter(d => d.message_type === type && d.status === 'acknowledged').length / 
                              state.data.filter(d => d.message_type === type).length) * 100).toFixed(1)
            }));
            
            if (messageTypeStats.length > 0) {
                const responseCtx = document.getElementById('response-chart').getContext('2d');
                state.charts.response = new Chart(responseCtx, {
                    type: 'bar',
                    data: {
                        labels: messageTypeStats.map(stat => 
                            stat.type ? stat.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Unknown'
                        ),
                        datasets: [{
                            label: 'Response Rate (%)',
                            data: messageTypeStats.map(stat => parseFloat(stat.responseRate)),
                            backgroundColor: ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#6b7280'],
                            borderRadius: 10,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                grid: { color: 'rgba(0,0,0,0.1)' },
                                ticks: {
                                    callback: (value) => value + '%',
                                    font: { weight: 'bold' }
                                }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { font: { weight: 'bold' }, maxRotation: 45 }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const stat = messageTypeStats[context.dataIndex];
                                        return [
                                            `Response Rate: ${context.parsed.y}%`,
                                            `Total Messages: ${stat.total}`,
                                            `Acknowledged: ${stat.acknowledged}`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Update response stats
                const responseStatsContainer = document.getElementById('response-stats');
                responseStatsContainer.innerHTML = messageTypeStats.map(stat => `
                    <div class="col-md-6">
                        <div class="alert alert-light mb-2 py-2">
                            <div class="d-flex justify-content-between">
                                <small class="fw-semibold">${stat.type ? stat.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Unknown'}</small>
                                <small class="text-primary fw-bold">${stat.responseRate}%</small>
                            </div>
                            <small class="text-muted">${stat.total} total messages</small>
                        </div>
                    </div>
                `).join('');
            }
        };

        const renderInsights = () => {
            const stats = calculateStats(state.data);
            const container = document.getElementById('insights-grid');
            
            const responseRate = (stats.acknowledged / stats.total) * 100;
            const engagementLevel = responseRate >= 70 ? 'Excellent' : responseRate >= 50 ? 'Good' : 'Needs Improvement';
            
            container.innerHTML = `
                <div class="col-md-6">
                    <div class="alert alert-primary insight-card primary">
                        <h6 class="alert-heading">üìà Message Analysis</h6>
                        <p class="mb-1">
                            <strong>${stats.messageTypes.length}</strong> different message types across 
                            <strong>${stats.total}</strong> messages.
                        </p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-success insight-card success">
                        <h6 class="alert-heading">‚úÖ Engagement Score</h6>
                        <p class="mb-1">
                            <strong>${responseRate.toFixed(1)}%</strong> overall acknowledgment rate
                        </p>
                        <small>${engagementLevel} team responsiveness</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-warning insight-card warning">
                        <h6 class="alert-heading">‚ö†Ô∏è Unacknowledged Messages</h6>
                        <p class="mb-1">
                            <strong>${stats.sent}</strong> messages (${((stats.sent / stats.total) * 100).toFixed(1)}%) remain unacknowledged
                        </p>
                        <small>Potential communication gap</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-danger insight-card danger">
                        <h6 class="alert-heading">üõ°Ô∏è Compliance Issues</h6>
                        <p class="mb-1">
                            <strong>${stats.cannotComply}</strong> cannot comply, 
                            <strong>${stats.issueReported}</strong> issues reported
                        </p>
                        <small>Require immediate attention</small>
                    </div>
                </div>
            `;
        };

        const applyFilters = () => {
            let filtered = state.data;

            if (state.filters.messageType !== 'all') {
                filtered = filtered.filter(d => d.message_type === state.filters.messageType);
            }

            if (state.filters.status !== 'all') {
                filtered = filtered.filter(d => d.status === state.filters.status);
            }

            if (state.filters.searchUser) {
                filtered = filtered.filter(d => 
                    d.user_name && d.user_name.toLowerCase().includes(state.filters.searchUser.toLowerCase())
                );
            }

            state.filteredData = filtered;
            state.currentPage = 1;
            renderTable();
        };

        const applySorting = () => {
            if (!state.sortConfig.key) return;
            
            state.filteredData.sort((a, b) => {
                const aValue = a[state.sortConfig.key];
                const bValue = b[state.sortConfig.key];
                
                if (aValue < bValue) return state.sortConfig.direction === 'asc' ? -1 : 1;
                if (aValue > bValue) return state.sortConfig.direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            renderTable();
        };

        const renderTable = () => {
            const startIndex = (state.currentPage - 1) * state.itemsPerPage;
            const endIndex = Math.min(startIndex + state.itemsPerPage, state.filteredData.length);
            const paginatedData = state.filteredData.slice(startIndex, endIndex);
            
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = paginatedData.map((row, index) => `
                <tr class="${state.highlightIssues && row.status === 'cannot_comply' ? 'highlight-cannot-comply' : ''}
                           ${state.highlightIssues && row.status === 'issue_reported' ? 'highlight-issue-reported' : ''}">
                    <td>
                        ${row.user_name ? 
                            `<div class="fw-semibold">${row.user_name}</div>` :
                            '<span class="badge bg-danger">‚ö†Ô∏è Missing Data</span>'
                        }
                    </td>
                    <td>
                        <span class="badge badge-modern ${
                            row.message_type?.includes('morning') ? 'bg-info' : 
                            row.message_type?.includes('evening') ? 'bg-purple text-white' :
                            row.message_type?.includes('mid') ? 'bg-success' : 'bg-secondary'
                        }">
                            ${row.message_type ? row.message_type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Unknown'}
                        </span>
                    </td>
                    <td>${getStatusBadge(row.status)}</td>
                    <td><small class="font-monospace text-muted">${formatDateTime(row.sent_at)}</small></td>
                    <td>
                        ${row.acknowledged_at ? 
                            `<small class="font-monospace text-success">${formatDateTime(row.acknowledged_at)}</small>` :
                            '<span class="text-muted fst-italic">Not acknowledged</span>'
                        }
                    </td>
                    <td>
                        <div class="text-truncate" style="max-width: 200px;" title="${row.message_content || ''}">
                            ${row.message_content || '<span class="text-muted fst-italic">No content</span>'}
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // Update table title and pagination
            document.getElementById('table-title').textContent = `üìã Message Details (${state.filteredData.length.toLocaleString()} records)`;
            
            const totalPages = Math.ceil(state.filteredData.length / state.itemsPerPage);
            document.getElementById('page-badge').textContent = `Page ${state.currentPage} of ${totalPages}`;
            document.getElementById('pagination-info').textContent = 
                `Showing ${startIndex + 1} to ${endIndex} of ${state.filteredData.length} results`;
            
            renderPagination(totalPages);
        };

        const renderPagination = (totalPages) => {
            const pagination = document.getElementById('pagination');
            const maxVisible = 5;
            let start = Math.max(1, state.currentPage - Math.floor(maxVisible / 2));
            let end = Math.min(totalPages, start + maxVisible - 1);
            
            if (end - start + 1 < maxVisible) {
                start = Math.max(1, end - maxVisible + 1);
            }

            let paginationHtml = `
                <li class="page-item ${state.currentPage === 1 ? 'disabled' : ''}">
                    <button class="page-link" onclick="changePage(${state.currentPage - 1})" ${state.currentPage === 1 ? 'disabled' : ''}>‚óÄ</button>
                </li>
            `;
            
            for (let i = start; i <= end; i++) {
                paginationHtml += `
                    <li class="page-item ${state.currentPage === i ? 'active' : ''}">
                        <button class="page-link" onclick="changePage(${i})">${i}</button>
                    </li>
                `;
            }
            
            paginationHtml += `
                <li class="page-item ${state.currentPage === totalPages ? 'disabled' : ''}">
                    <button class="page-link" onclick="changePage(${state.currentPage + 1})" ${state.currentPage === totalPages ? 'disabled' : ''}>‚ñ∂</button>
                </li>
            `;
            
            pagination.innerHTML = paginationHtml;
        };

        const exportCSV = () => {
            const csvContent = [
                ['User Name', 'Message Type', 'Status', 'Sent Time', 'Acknowledged Time', 'Message Content'].join(','),
                ...state.filteredData.map(row => [
                    row.user_name || 'N/A',
                    row.message_type || 'Unknown',
                    row.status,
                    formatDateTime(row.sent_at),
                    formatDateTime(row.acknowledged_at),
                    (row.message_content || '').replace(/"/g, '""')
                ].map(field => `"${field}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `task_response_data_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        };

        // Global functions for event handlers
        window.changePage = (page) => {
            const totalPages = Math.ceil(state.filteredData.length / state.itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                state.currentPage = page;
                renderTable();
            }
        };

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Set current date
            document.getElementById('current-date').textContent = new Date().toLocaleDateString();
            
            // Tab switching
            document.querySelectorAll('[data-tab]').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const targetTab = e.target.dataset.tab;
                    
                    // Update tab buttons
                    document.querySelectorAll('[data-tab]').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    // Show/hide tab content
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('show', 'active');
                    });
                    const targetContent = document.getElementById(`${targetTab}-content`);
                    targetContent.classList.add('show', 'active');
                });
            });
            
            // File upload
            const uploadZone = document.getElementById('upload-zone');
            const fileInput = document.getElementById('file-input');
            
            uploadZone.addEventListener('click', () => fileInput.click());
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            uploadZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
            });
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'application/json') {
                    handleFileUpload(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    handleFileUpload(e.target.files[0]);
                }
            });
            
            // Endpoint fetch
            document.getElementById('fetch-btn').addEventListener('click', handleEndpointFetch);
            document.getElementById('endpoint-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleEndpointFetch();
            });
            
            // Sample data
            document.getElementById('sample-btn').addEventListener('click', loadSampleData);
            
            // Filters
            document.getElementById('filter-type').addEventListener('change', (e) => {
                state.filters.messageType = e.target.value;
                applyFilters();
            });
            
            document.getElementById('filter-status').addEventListener('change', (e) => {
                state.filters.status = e.target.value;
                applyFilters();
            });
            
            document.getElementById('filter-user').addEventListener('input', (e) => {
                state.filters.searchUser = e.target.value;
                applyFilters();
            });
            
            // New data button
            document.getElementById('new-data-btn').addEventListener('click', () => {
                document.getElementById('data-source-section').style.display = 'block';
                document.getElementById('dashboard-content').classList.add('d-none');
            });
            
            // Sorting
            document.querySelectorAll('[data-sort]').forEach(header => {
                header.addEventListener('click', (e) => {
                    const key = e.currentTarget.dataset.sort;
                    let direction = 'asc';
                    
                    if (state.sortConfig.key === key && state.sortConfig.direction === 'asc') {
                        direction = 'desc';
                    }
                    
                    state.sortConfig = { key, direction };
                    
                    // Update sort icons
                    document.querySelectorAll('.sort-icon').forEach(icon => {
                        icon.textContent = '‚ÜïÔ∏è';
                    });
                    e.currentTarget.querySelector('.sort-icon').textContent = direction === 'asc' ? '‚Üë' : '‚Üì';
                    
                    applySorting();
                });
            });
            
            // Insights toggle
            document.getElementById('insights-toggle').addEventListener('click', () => {
                const body = document.getElementById('insights-body');
                const icon = document.querySelector('#insights-toggle span');
                
                if (body.style.display === 'none') {
                    body.style.display = 'block';
                    icon.textContent = 'üîΩ';
                    state.showInsights = true;
                } else {
                    body.style.display = 'none';
                    icon.textContent = '‚ñ∂Ô∏è';
                    state.showInsights = false;
                }
            });
            
            // Highlight issues
            document.getElementById('highlight-btn').addEventListener('click', (e) => {
                state.highlightIssues = !state.highlightIssues;
                e.target.textContent = state.highlightIssues ? 'üëÅÔ∏è Hide Issues' : 'üëÅÔ∏è Highlight Issues';
                e.target.className = state.highlightIssues ? 'btn btn-outline-danger' : 'btn btn-outline-danger';
                renderTable();
            });
            
            // Export
            document.getElementById('export-btn').addEventListener('click', exportCSV);
        });
    </script>
</body>
</html>